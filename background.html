<script type="text/javascript">
    /*!
     * Copyright 2010-2011, ebrahim@byagowi.com
     * Released under GPL Licenses.
     */

    "use strict";

    // Shared with options.html
    function loadOptionByName(optionName) {
        return JSON.parse(localStorage[optionName]);
    }

    function isStorageInitialized() {
        try {
            loadOptionByName("isInitialized");
            // well, loading of our saved data not raised error,
            // so storage is initialized before
            return true;
        } catch (e) {
            // loading saved data raised error, seems storage is
            // not initialized before
            return false;
        }
    }

    function initializeOptionsStorage() {
        saveOptionByName("simpleSwitch", true); // I prefer this be true by default
        saveOptionByName("pageSwitch", false);

        saveOptionByName("isInitialized", true);
    }

    function saveOptionByName(optionName, value) {
        localStorage[optionName] = value.toString();
    }

    // initialze options storage if not initialized before
    if (!isStorageInitialized()) {
        initializeOptionsStorage();
    }
    // till here

    // note: this function will be injected to the page.
    var switchDirection = function (element) {
        // removing "dir" attribute
        element.removeAttribute("dir");

        // set RTL or LTR direction in style of element
        if (window.getComputedStyle(element, null).getPropertyValue('direction') == 'rtl')
            element.style.direction = 'ltr';
        else
            element.style.direction = 'rtl';
    }

    if (loadOptionByName("pageSwitch") === true) {
        chrome.contextMenus.create({
            title: "Switch Page Direction",
            contexts: ["page"],
            onclick: function () {
                chrome.tabs.executeScript(null, { code: "(" + switchDirection + ")(document['body'])" });
            }
        });
    }

    if (loadOptionByName("simpleSwitch") === true) {
        chrome.contextMenus.create({
            title: "Switch Text Direction",
            contexts: ["editable"],
            onclick: function () {
                chrome.tabs.executeScript(null, {
                    code: "(" + switchDirection + ")(document['activeElement'])"
                });
            }
        });
    }
</script>
